<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>pdf > html</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://unpkg.com/tesseract.js@5.0.3/dist/tesseract.min.js"></script>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 10px;
      background: #f9f9f9;
      display: flex;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      flex: 1;
    }
    #canvasContainer {
      position: relative;
      display: inline-block;
      border: 1px solid #ccc;
      background: white;
      margin-top: 10px;
    }
    .debug-label {
      position: absolute;
      font-size: 10px;
      pointer-events: none;
      background: rgba(255, 255, 0, 0.7);
      border: 1px solid red;
      padding: 1px 3px;
      white-space: nowrap;
      z-index: 10;
      transform: translateY(-100%);
    }
    .line-label {
      background: rgba(255, 0, 0, 0.7) !important;
      border-color: black !important;
      color: white !important;
      font-weight: bold;
    }
    pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 12px;
      border-radius: 4px;
      overflow: auto;
      font-size: 12px;
      line-height: 1.4;
    }
    .panel {
      background: #fff;
      padding: 12px;
      border-radius: 6px;
      margin: 10px 0;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      
    }
    .buttons
    {
      width: 100%; height: auto;
      position: relative;
      margin: 5px;
    }
    input[type="text"] {
      width: 90%;
      padding: 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .match-card {
      background: #e8f4fd;
      border-left: 4px solid #007acc;
      padding: 12px;
      margin-top: 10px;
      border-radius: 4px;
    }
    button {
      padding: 8px 16px;
      margin: 0 6px;
      background: #007acc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { opacity: 0.9; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    #detectLinesBtn { background: #8e3dff; }
    #status { 
      color: #d9534f; 
      font-weight: bold;
      margin: 8px 0;
    }

    /* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    #floorPanel {
      width: 280px;
      background: white;
      border-left: 1px solid #ddd;
      padding: 15px;
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
      position: fixed;
      top: 0;
      right: 0;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
      display: none;
    }
    #floorNav {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    #floorNav button {
      padding: 6px 12px;
      background: #3498db;
      font-size: 18px;
    }
    #currentFloor {
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      padding: 8px;
      background: #ecf0f1;
      border-radius: 4px;
    }
    .floor-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin: 10px 0;
    }
    .floor-content {
      background: #fff;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 4px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .exact-match {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .highlight-box {
      position: absolute;
      border: 3px solid #3498db;
      pointer-events: none;
      z-index: 5;
    }
    .pdf-table {
        position: absolute;
  border-collapse: collapse;
  font-family: Arial, sans-serif;
  width: 50%;
  margin: 10px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
  border-radius: 15px;
  overflow: hidden;
}

.pdf-table td,
.pdf-table th {
  border: 1px solid #ddd;
  padding: 10px;
  text-align: left;
  vertical-align: top;
}

.pdf-table tr:nth-child(even) {
  background-color: #f9f9f9;
}

h2 
{
  position: relative; padding: 0; margin: 0; color: rgb(134, 93, 247); margin-left: 120px;
}
  </style>
  <style>
    #selectionRect {
  background: rgba(52, 152, 219, 0.1);
}
  </style>
  <style>
    .buttonspannel
    {
      width: 300px;
      height: auto;
    }
    .buttonspannel button 
    {
      margin: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>pdf > html</h2>
    <p style="padding: 5px;"><a href="index.html" style="color: inherit; text-decoration: none; display: block; height: 40px; width: 40px; position: absolute; top: 0; left: 0; margin: 10px;">‚Ü©Ô∏è </a></p>
    <div class="panel">
      <input type="file" id="pdfFile" accept="application/pdf" />
<div class="buttons">
  <button id="loadBtn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  <button id="detectLinesBtn" disabled>üîç –ê–Ω–∞–ª–∏–∑</button>
</div>
      <div id="status">–í—ã–±–µ—Ä–∏—Ç–µ PDF...</div>
    </div>

<div class="panel">
  <label>–ü–æ–∏—Å–∫ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é:</label><br>
  <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..." disabled>
  
  <!-- –ù–û–í–û–ï: –≤—ã–±–æ—Ä —ç—Ç–∞–∂–∞-—à–∞–ø–∫–∏ -->
  <div style="margin-top:8px; font-size:13px;">
    <label>–®–∞–ø–∫–∞ —Ç–∞–±–ª–∏—Ü—ã:</label>
    <select id="headerFloorSelect" disabled>
      <option value="-1">–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</option>
    </select>
  </div>

  <div class="exact-match">
    <input type="checkbox" id="exactMatch" />
    <label for="exactMatch">–¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ</label>
  </div>
  <div id="searchResult"></div>
</div>

    <!-- <div class="panel">
      <label>–ü–æ–∏—Å–∫ –ø–æ –∑–Ω–∞—á–µ–Ω–∏—é:</label><br>
      <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..." disabled>
      <div class="exact-match">
        <input type="checkbox" id="exactMatch" />
        <label for="exactMatch">–¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ</label>
      </div>
      <div id="searchResult"></div>
    </div> -->

    <div class="buttonspannel" style="display: block; outline: 2px solid black; padding: 10px;">
      <button id="showHtmlBtn">üëÄ –ü–æ–∫–∞–∑–∞—Ç—å html</button>
      <button id="copyHtmlBtn">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="enableSelectMode">–í—ã–¥–µ–ª–∏—Ç—å</button>
      <button id="regionModeBtn">–†–µ–≥–∏–æ–Ω</button>
      <button id="exportRegionsBtn">–≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–≥–∏–æ–Ω–æ–≤</button>
      <button id="exportFullHtmlBtn">–ü–æ–ª–Ω—ã–π –∫–ª–æ–Ω</button>
    </div>


<div id="regionsContainer"></div>

<!-- –°–ª–æ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è HTML-—Ç–∞–±–ª–∏—Ü—ã -->
<div id="htmlOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:white; z-index:1000; padding:20px; overflow:auto;">
  <button id="closeHtmlOverlay" style="position:fixed; top:5px; left:5px; background:#e74c3c; color:white; border:none; width:30px; height:30px; border-radius:50%; font-weight:bold; cursor:pointer;">√ó</button>
  <div id="renderedHtmlTable"></div>
</div>

    <!-- <button id="createHtmlTableBtn">üìÑ –°–æ–∑–¥–∞—Ç—å HTML-—Ç–∞–±–ª–∏—Ü—É</button> -->
<div class="panel" id="htmlTableOutput" style="display:none;">
  <h3>HTML-—Ç–∞–±–ª–∏—Ü–∞:</h3>
  <pre id="htmlTableCode"></pre>
</div>

    <div id="canvasContainer">
      <canvas id="pdfCanvas"></canvas>
      <div id="selectionRect" style="position:absolute; border:2px dashed #3498db; display:none; pointer-events:none; z-index:100;"></div>
    </div>

    <div class="panel">
      <h3>–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏ (–ø–æ –ª–∏–Ω–∏—è–º –∏–ª–∏ –ø–æ Y):</h3>
      <pre id="output"></pre>
    </div>
  </div>

  <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —ç—Ç–∞–∂–∞–º–∏ -->
  <div id="floorPanel">
    <h3>–ù–∞–≤–∏–≥–∞—Ü–∏—è</h3>
    <div id="floorNav">
      <button id="prevFloor">‚Üê</button>
      <div id="currentFloor">-</div>
      <button id="nextFloor">‚Üí</button>
    </div>
    <div class="floor-info">
      <strong>—Å—Ç—Ä–æ–∫–∏:</strong><br>
      <span id="floorTopLine">-</span><br>
      <span id="floorBottomLine">-</span>
    </div>
    <div class="floor-content" id="floorContent">
      [–°–æ–¥–µ—Ä–∂–∏–º–æ–µ —ç—Ç–∞–∂–∞]
    </div>
  </div>

  <script>
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let canvas = null;
    let ctx = null;
    let viewport = null;
    let currentPage = null;
    let currentTextContent = null;
    let structuredRows = [];
    let horizontalLines = [];
    let verticalBreaks = []; // ‚Üê –¥–æ–±–∞–≤—å —ç—Ç—É —Å—Ç—Ä–æ–∫—É
    let currentFloorIndex = -1;

    // === –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π ===
    function detectHorizontalLines() {
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const data = imageData.data;
      const threshold = 128;
      const minLineLength = 80;
      const lines = [];

      for (let y = 0; y < canvas.height; y++) {
        let startX = -1;
        for (let x = 0; x <= canvas.width; x++) {
          if (x < canvas.width) {
            const i = (y * canvas.width + x) * 4;
            const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
            if (brightness <= threshold) {
              if (startX === -1) startX = x;
            } else {
              if (startX !== -1 && (x - startX) >= minLineLength) {
                lines.push({ y, startX, endX: x - 1 });
              }
              startX = -1;
            }
          } else {
            if (startX !== -1 && (x - startX) >= minLineLength) {
              lines.push({ y, startX, endX: x - 1 });
            }
          }
        }
      }
      return lines;
    }

    function detectVerticalLines() {
  if (!ctx || !canvas) return [];

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const data = imageData.data;
  const threshold = 128;
  const minLineHeight = 30; // –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏
  const lines = [];

  for (let x = 0; x < canvas.width; x++) {
    let startY = -1;
    for (let y = 0; y <= canvas.height; y++) {
      if (y < canvas.height) {
        const i = (y * canvas.width + x) * 4;
        const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
        if (brightness <= threshold) {
          if (startY === -1) startY = y;
        } else {
          if (startY !== -1 && (y - startY) >= minLineHeight) {
            lines.push({ x, startY, endY: y - 1 });
          }
          startY = -1;
        }
      } else {
        if (startY !== -1 && (y - startY) >= minLineHeight) {
          lines.push({ x, startY, endY: y - 1 });
        }
      }
    }
  }

  // –£–±–∏—Ä–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã (–ª–∏–Ω–∏–∏ —Ç–æ–ª—â–∏–Ω–æ–π >1px)
  const filteredLines = [];
  let lastX = -100;
  for (const line of lines) {
    if (line.x - lastX > 2) { // –¥–æ–ø—É—Å–∫ 2px
      filteredLines.push(line);
      lastX = line.x;
    }
  }

  return filteredLines;
}

//     function detectVerticalLines() {
//   if (!currentTextContent || !viewport) return [];

//   const blocks = currentTextContent.items
//     .filter(item => item.str.trim())
//     .map(item => {
//       const [a, b, c, d, x, y] = item.transform;
//       const pt = viewport.convertToViewportPoint(x, y);
//       // –í—ã—á–∏—Å–ª—è–µ–º –≤—ã—Å–æ—Ç—É –±–ª–æ–∫–∞ (–ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–æ)
//       const height = Math.sqrt(c * c + d * d) * 12; // 12px ‚Äî –±–∞–∑–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞
//       return { 
//         text: item.str.trim(), 
//         x: pt[0], 
//         y: pt[1], 
//         height: height,
//         transform: item.transform
//       };
//     });

//   // –°—Ä–µ–¥–Ω—è—è –≤—ã—Å–æ—Ç–∞ —Å—Ç—Ä–æ–∫
//   const avgHeight = blocks.reduce((sum, b) => sum + b.height, 0) / blocks.length;

//   // –ü–æ—Ä–æ–≥: –µ—Å–ª–∏ –≤—ã—Å–æ—Ç–∞ > 2x —Å—Ä–µ–¥–Ω–µ–π ‚Äî —ç—Ç–æ –ª–∏–Ω–∏—è
//   const LINE_THRESHOLD = avgHeight * 2;

//   const verticalLines = [];

//   blocks.forEach(block => {
//     if (block.height > LINE_THRESHOLD) {
//       verticalLines.push({
//         x: block.x,
//         y: block.y,
//         height: block.height,
//         label: 'break'
//       });
//     }
//   });

//   return verticalLines;
// }
    
// === –§–£–ù–ö–¶–ò–Ø: –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –±–ª–æ–∫–æ–≤ –ø–æ "—ç—Ç–∞–∂–∞–º" –º–µ–∂–¥—É –ª–∏–Ω–∏—è–º–∏ ===
    
function groupBlocksIntoRows(blocks) {
      if (horizontalLines.length === 0) {
        const TOLERANCE = 5;
        const rows = [];
        const sortedByY = blocks.sort((a, b) => a.y - b.y);
        for (const block of sortedByY) {
          const existingRow = rows.find(row => Math.abs(row.y - block.y) <= TOLERANCE);
          if (existingRow) {
            existingRow.blocks.push(block);
          } else {
            rows.push({ y: block.y, blocks: [block] });
          }
        }
        rows.forEach(row => row.blocks.sort((a, b) => a.x - b.x));
        return rows;
      }

      const sortedLines = [...horizontalLines].sort((a, b) => a.y - b.y);
      const rows = [];

      blocks.forEach(block => {
        let rowIndex = -1;
        for (let i = 0; i < sortedLines.length - 1; i++) {
          if (block.y > sortedLines[i].y && block.y < sortedLines[i + 1].y) {
            rowIndex = i;
            break;
          }
        }
        if (rowIndex === -1) rowIndex = sortedLines.length - 1;

        if (!rows[rowIndex]) {
          rows[rowIndex] = { 
            y: sortedLines[rowIndex]?.y || block.y, 
            topLine: sortedLines[rowIndex],
            bottomLine: sortedLines[rowIndex + 1],
            blocks: [] 
          };
        }
        rows[rowIndex].blocks.push(block);
      });

      const filteredRows = rows.filter(row => row !== undefined && row.blocks && row.blocks.length > 0);
      filteredRows.forEach(row => row.blocks.sort((a, b) => a.x - b.x));
      return filteredRows;
    }

    // === –§–£–ù–ö–¶–ò–Ø: –ü–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É ===
    function findRowByQuery(query, exactMatch = false) {
      if (!query.trim()) return null;
      
      return structuredRows.filter(row => {
        return row.blocks.some(block => {
          if (exactMatch) {
            return block.text.toLowerCase() === query.toLowerCase();
          } else {
            return block.text.toLowerCase().includes(query.toLowerCase());
          }
        });
      });
    }

    // === –ó–ê–ì–†–£–ó–ö–ê PDF ===
    document.getElementById('loadBtn').addEventListener('click', async () => {
      const file = document.getElementById('pdfFile').files[0];
      if (!file) return alert('–í—ã–±–µ—Ä–∏—Ç–µ PDF');

      document.getElementById('status').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ PDF...';
      document.getElementById('detectLinesBtn').disabled = true;
      document.getElementById('searchInput').disabled = true;

      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        currentPage = await pdf.getPage(1);

        viewport = currentPage.getViewport({ scale: 2.0 });
        canvas = document.getElementById('pdfCanvas');
        ctx = canvas.getContext('2d');
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        await currentPage.render({ canvasContext: ctx, viewport }).promise;

        currentTextContent = await currentPage.getTextContent();
        const blocks = currentTextContent.items
          .filter(item => item.str.trim())
          .map(item => {
            const [,, , , x, y] = item.transform;
            const screenPoint = viewport.convertToViewportPoint(x, y);
            return { 
              text: item.str.trim(), 
              x: screenPoint[0], 
              y: screenPoint[1] 
            };
          });

        structuredRows = groupBlocksIntoRows(blocks);
        updateOutputAndLabels();
        updateHeaderFloorSelect(); // ‚úÖ –¥–æ–±–∞–≤–ª–µ–Ω–æ
        document.getElementById('status').textContent = 'PDF –ì–æ—Ç–æ–≤.';
        document.getElementById('detectLinesBtn').disabled = false;
        document.getElementById('searchInput').disabled = false;

        document.getElementById('searchInput').oninput = () => {
  const query = document.getElementById('searchInput').value;
  const exactMatch = document.getElementById('exactMatch').checked;
  const headerIndex = parseInt(document.getElementById('headerFloorSelect').value);
  const resultDiv = document.getElementById('searchResult');
  
  if (!query) {
    resultDiv.innerHTML = '';
    return;
  }

  const foundRows = findRowByQuery(query, exactMatch);
  if (foundRows.length > 0) {
    resultDiv.innerHTML = '';
    foundRows.forEach((row, idx) => {
      let cardHtml = `<div class="match-card"><strong>–ù–∞–π–¥–µ–Ω–æ (—Å—Ç—Ä–æ–∫–∞ ${structuredRows.indexOf(row)}):</strong><br>`;

      if (headerIndex >= 0 && headerIndex < structuredRows.length) {
        const headerRow = structuredRows[headerIndex];
        const dataRow = row;

        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤ –∫–æ–ª–æ–Ω–∫–∏
        const headerColumns = detectColumns(headerRow.blocks);
        const dataColumns = detectColumns(dataRow.blocks);

        // –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏ ‚Äî –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ –∫–∞–∫ –º–µ—Ç–∫—É
        headerColumns.forEach((col, i) => {
          const label = col[0] ? col[0].text : `–ö–æ–ª–æ–Ω–∫–∞ ${i + 1}`;
          const dataBlock = dataColumns[i] ? dataColumns[i][0] : null;
          const dataText = dataBlock ? dataBlock.text : '‚Äî';
          cardHtml += `<div><span style="color:#8e44ad; font-weight:bold;">${label}:</span> ${dataText}</div>`;
        });
      } else {
        // –ë–µ–∑ —à–∞–ø–∫–∏ ‚Äî –≤—ã–≤–æ–¥–∏–º –≤—Å–µ –±–ª–æ–∫–∏ —Å—Ç—Ä–æ–∫–∏
        row.blocks.forEach((block, i) => {
  cardHtml += `<div>[${i}] X:${block.x.toFixed(0)} Y:${block.y.toFixed(0)} ‚Üí ${block.text}</div>`;
});
        // row.blocks.forEach(block => {
        //   cardHtml += `<div>${block.text}</div>`;
        // });
      }

      cardHtml += '</div>';
      resultDiv.innerHTML += cardHtml;
    });
  } else {
    resultDiv.innerHTML = '<div style="color:#d9534f">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
  }
};

//         document.getElementById('searchInput').oninput = () => {
//   const query = document.getElementById('searchInput').value;
//   const exactMatch = document.getElementById('exactMatch').checked;
//   const headerIndex = parseInt(document.getElementById('headerFloorSelect').value);
//   const resultDiv = document.getElementById('searchResult');
  
//   if (!query) {
//     resultDiv.innerHTML = '';
//     return;
//   }

//   const foundRows = findRowByQuery(query, exactMatch);
//   if (foundRows.length > 0) {
//     resultDiv.innerHTML = '';
//     foundRows.forEach((row, idx) => {
//       let cardHtml = `<div class="match-card"><strong>–ù–∞–π–¥–µ–Ω–æ (—Å—Ç—Ä–æ–∫–∞ ${structuredRows.indexOf(row)}):</strong><br>`;

//       if (headerIndex >= 0 && headerIndex < structuredRows.length) {
//         const headerRow = structuredRows[headerIndex];
//         const dataRow = row;

//         // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ X
//         const sortedHeader = [...headerRow.blocks].sort((a, b) => a.x - b.x);
//         const sortedData = [...dataRow.blocks].sort((a, b) => a.x - b.x);

//         // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏ ‚Äî –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏
//         if (verticalBreaks.length > 0) {
//           // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã: –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Å—Ç—Ä–∞–Ω–∏—Ü—ã
//           const allBreaks = [0, ...verticalBreaks, viewport.width];
//           allBreaks.sort((a, b) => a - b);

//           // –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏ ‚Äî –±–µ—Ä—ë–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –¥–∞–Ω–Ω—ã–µ
//           for (let i = 0; i < allBreaks.length - 1; i++) {
//             const left = allBreaks[i];
//             const right = allBreaks[i + 1];

//             // –ò—â–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –≤ —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–µ
//             const headerInCol = sortedHeader.find(b => b.x >= left && b.x < right);
//             const dataInCol = sortedData.find(b => b.x >= left && b.x < right);

//             const label = headerInCol ? headerInCol.text : `–ö–æ–ª–æ–Ω–∫–∞ ${i + 1}`;
//             const dataText = dataInCol ? dataInCol.text : '‚Äî';
//             cardHtml += `<div><span style="color:#8e44ad; font-weight:bold;">${label}:</span> ${dataText}</div>`;
//           }
//         } else {
//           // –ë–µ–∑ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π ‚Äî –∫–∞–∫ —Ä–∞–Ω—å—à–µ
//           sortedHeader.forEach((headerBlock, i) => {
//             const dataBlock = sortedData[i];
//             const dataText = dataBlock ? dataBlock.text : '‚Äî';
//             cardHtml += `<div><span style="color:#8e44ad; font-weight:bold;">${headerBlock.text}:</span> ${dataText}</div>`;
//           });
//         }
//       } else {
//         row.blocks.forEach(block => {
//           cardHtml += `<div>${block.text}</div>`;
//         });
//       }

//       cardHtml += '</div>';
//       resultDiv.innerHTML += cardHtml;
//     });
//   } else {
//     resultDiv.innerHTML = '<div style="color:#d9534f">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
//   }
// };

//         document.getElementById('searchInput').oninput = () => {
//   const query = document.getElementById('searchInput').value;
//   const exactMatch = document.getElementById('exactMatch').checked;
//   const headerIndex = parseInt(document.getElementById('headerFloorSelect').value);
//   const resultDiv = document.getElementById('searchResult');
  
//   if (!query) {
//     resultDiv.innerHTML = '';
//     return;
//   }

//   const foundRows = findRowByQuery(query, exactMatch);
//   if (foundRows.length > 0) {
//     resultDiv.innerHTML = '';
//     foundRows.forEach((row, idx) => {
//       let cardHtml = `<div class="match-card"><strong>–ù–∞–π–¥–µ–Ω–æ (—Å—Ç—Ä–æ–∫–∞ ${structuredRows.indexOf(row)}):</strong><br>`;

//       if (headerIndex >= 0 && headerIndex < structuredRows.length) {
//         const headerRow = structuredRows[headerIndex];
//         const dataRow = row;

//         // –ì–†–£–ü–ü–ò–†–£–ï–ú –í –ö–û–õ–û–ù–ö–ò
//         const headerColumns = detectColumns(headerRow.blocks);
//         const dataColumns = detectColumns(dataRow.blocks);

//         // –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–ª–æ–Ω–∫–∏ ‚Äî –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ –∫–∞–∫ –º–µ—Ç–∫—É
//         // –í—ã–≤–æ–¥–∏–º –í–°–ï –∫–æ–ª–æ–Ω–∫–∏ –∏–∑ —à–∞–ø–∫–∏
// headerColumns.forEach((col, i) => {
//   const label = col[0] ? col[0].text : `–ö–æ–ª–æ–Ω–∫–∞ ${i + 1}`;
//   const dataBlock = dataColumns[i] ? dataColumns[i][0] : null;
//   const dataText = dataBlock ? dataBlock.text : '‚Äî';
//   cardHtml += `<div><span style="color:#8e44ad; font-weight:bold;">${label}:</span> ${dataText}</div>`;
// });
//         // headerColumns.forEach((col, i) => {
//         //   const label = col[0] ? col[0].text : `–ö–æ–ª–æ–Ω–∫–∞ ${i + 1}`;
//         //   const dataBlock = dataColumns[i] ? dataColumns[i][0] : null;
//         //   if (dataBlock) {
//         //     cardHtml += `<div><span style="color:#8e44ad; font-weight:bold;">${label}:</span> ${dataBlock.text}</div>`;
//         //   }
//         // });
//       } else {
//         row.blocks.forEach(block => {
//           cardHtml += `<div>${block.text}</div>`;
//         });
//       }

//       cardHtml += '</div>';
//       resultDiv.innerHTML += cardHtml;
//     });
//   } else {
//     resultDiv.innerHTML = '<div style="color:#d9534f">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
//   }
// };

//         document.getElementById('searchInput').oninput = () => {
//   const query = document.getElementById('searchInput').value;
//   const exactMatch = document.getElementById('exactMatch').checked;
//   const headerIndex = parseInt(document.getElementById('headerFloorSelect').value);
//   const resultDiv = document.getElementById('searchResult');
  
//   if (!query) {
//     resultDiv.innerHTML = '';
//     return;
//   }

//   const foundRows = findRowByQuery(query, exactMatch);
//   if (foundRows.length > 0) {
//     resultDiv.innerHTML = '';
//     foundRows.forEach((row, idx) => {
//       let cardHtml = `<div class="match-card"><strong>–ù–∞–π–¥–µ–Ω–æ (—Å—Ç—Ä–æ–∫–∞ ${structuredRows.indexOf(row)}):</strong><br>`;

//       // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ —à–∞–ø–∫–∞ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ—ë –∫–∞–∫ –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫
//       if (headerIndex >= 0 && headerIndex < structuredRows.length) {
//         const headerRow = structuredRows[headerIndex];
//         // –°–æ—Ä—Ç–∏—Ä—É–µ–º –±–ª–æ–∫–∏ —à–∞–ø–∫–∏ –∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ X
//         const sortedHeader = [...headerRow.blocks].sort((a, b) => a.x - b.x);
//         const sortedData = [...row.blocks].sort((a, b) => a.x - b.x);

//         // –°–æ–ø–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É
//         sortedData.forEach((block, i) => {
//           const label = sortedHeader[i] ? sortedHeader[i].text : `–ö–æ–ª–æ–Ω–∫–∞ ${i + 1}`;
//           cardHtml += `<div><strong>${label}:</strong> ${block.text}</div>`;
//         });
//       } else {
//         // –ë–µ–∑ —à–∞–ø–∫–∏ ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ–º
//         row.blocks.forEach(block => {
//           cardHtml += `<div>${block.text}</div>`;
//         });
//       }

//       cardHtml += '</div>';
//       resultDiv.innerHTML += cardHtml;
//     });
//   } else {
//     resultDiv.innerHTML = '<div style="color:#d9534f">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
//   }
// };
        


// document.getElementById('searchInput').oninput = () => {
        //   const query = document.getElementById('searchInput').value;
        //   const exactMatch = document.getElementById('exactMatch').checked;
        //   const resultDiv = document.getElementById('searchResult');
          
        //   if (!query) {
        //     resultDiv.innerHTML = '';
        //     return;
        //   }

        //   const foundRows = findRowByQuery(query, exactMatch);
        //   if (foundRows.length > 0) {
        //     resultDiv.innerHTML = '';
        //     foundRows.forEach((row, idx) => {
        //       const rowText = row.blocks.map(b => b.text).join(' | ');
        //       resultDiv.innerHTML += `<div class="match-card"><strong>–ù–∞–π–¥–µ–Ω–æ (—Å—Ç—Ä–æ–∫–∞ ${idx}):</strong> ${rowText}</div>`;
        //     });
        //   } else {
        //     resultDiv.innerHTML = '<div style="color:#d9534f">–ù–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
        //   }
        // };

      } catch (error) {
        document.getElementById('status').textContent = '–û—à–∏–±–∫–∞: ' + error.message;
        console.error(error);
      }
    });
    // === –û–ë–ù–ê–†–£–ñ–ï–ù–ò–ï –õ–ò–ù–ò–ô ===
    document.getElementById('detectLinesBtn').addEventListener('click', async () => {
      if (!currentPage) return;

      document.getElementById('status').textContent = '–ê–Ω–∞–ª–∏–∑...';
      document.querySelectorAll('.debug-label').forEach(el => el.remove());

      horizontalLines = detectHorizontalLines();

      await currentPage.render({ canvasContext: ctx, viewport }).promise;

      ctx.strokeStyle = '#00ff00';
      ctx.lineWidth = 2;
      horizontalLines.forEach(line => {
        ctx.beginPath();
        ctx.moveTo(line.startX, line.y);
        ctx.lineTo(line.endX, line.y);
        ctx.stroke();

        // üî• –ë–≠–ô–î–ñ–ò–ö –¢–û–ß–ù–û –ù–ê –õ–ò–ù–ò–ò ‚Äî –±–µ–∑ –æ—Ç—Å—Ç—É–ø–∞ –≤–≤–µ—Ä—Ö
        const label = document.createElement('div');
        label.className = 'debug-label line-label';
        label.textContent = `Y=${Math.round(line.y)}`;
        label.style.left = `${line.startX + 10}px`;
        label.style.top = `${line.y}px`; // –¢–û–ß–ù–û –ù–ê –õ–ò–ù–ò–ò ‚Äî –±–µ–∑ —Å–º–µ—â–µ–Ω–∏—è
        document.getElementById('canvasContainer').appendChild(label);
      });

      // –ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –Ω–∞—Ä–∏—Å–æ–≤–∞–ª –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
const verticalLines = detectVerticalLines();
verticalBreaks = verticalLines.map(line => line.x).sort((a, b) => a - b);

verticalLines.forEach(line => {
  const circle = document.createElement('div');
  circle.style.cssText = `
    position: absolute;
    width: 10px;
    height: 10px;
    background: red;
    border-radius: 50%;
    border: 2px solid white;
    left: ${line.x - 5}px;
    top: ${(line.startY + line.endY) / 2 - 5}px; /* ‚Üê —Å–µ—Ä–µ–¥–∏–Ω–∞ –ª–∏–Ω–∏–∏ */
    z-index: 9999;
    pointer-events: none;
  `;
  canvasContainer.appendChild(circle);

  const label = document.createElement('div');
  label.className = 'debug-label';
  label.textContent = 'break';
  label.style.left = `${line.x + 10}px`;
  label.style.top = `${(line.startY + line.endY) / 2}px`; /* ‚Üê —Å–µ—Ä–µ–¥–∏–Ω–∞ */
  label.style.background = 'red';
  label.style.color = 'white';
  label.style.fontSize = '10px';
  canvasContainer.appendChild(label);
});

// –ü–æ—Å–ª–µ —Ä–∏—Å–æ–≤–∞–Ω–∏—è –∫—Ä—É–∂–æ—á–∫–æ–≤ –≤–≤–µ—Ä—Ö—É ‚Äî —Ä–∏—Å—É–µ–º –Ω–∞ –∫–∞–∂–¥–æ–º —ç—Ç–∞–∂–µ
structuredRows.forEach(row => {
  const midY = row.y; // –∏–ª–∏ (row.topLine?.y || 0) + 10
  verticalLines.forEach(line => {
    const circle = document.createElement('div');
    circle.style.cssText = `
      position: absolute;
      width: 6px;
      height: 6px;
      background: red;
      border-radius: 50%;
      left: ${line.x - 3}px;
      top: ${midY - 3}px;
      z-index: 9998;
      pointer-events: none;
    `;
    canvasContainer.appendChild(circle);
  });
});
      
const blocks = currentTextContent.items
        .filter(item => item.str.trim())
        .map(item => {
          const [,, , , x, y] = item.transform;
          const screenPoint = viewport.convertToViewportPoint(x, y);
          return { 
            text: item.str.trim(), 
            x: screenPoint[0], 
            y: screenPoint[1] 
          };
        });

      structuredRows = groupBlocksIntoRows(blocks);
      updateOutputAndLabels();
      currentFloorIndex = -1; // —Å–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–∂
      updateFloorPanel(); // –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞–Ω–µ–ª—å
      updateHeaderFloorSelect(); // ‚úÖ –≤–æ—Ç —Å—é–¥–∞!
      document.getElementById('status').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${horizontalLines.length}.`;
    });

    // === –§–£–ù–ö–¶–ò–Ø: –ì–†–£–ü–ü–ò–†–û–í–ö–ê –ë–õ–û–ö–û–í –í –ö–û–õ–û–ù–ö–ò ===
function detectColumns(blocks) {
  if (blocks.length === 0) return [];

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ X
  const sorted = [...blocks].sort((a, b) => a.x - b.x);

  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
  if (verticalBreaks.length > 0) {
  // –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã: –Ω–∞—á–∞–ª–æ –∏ –∫–æ–Ω–µ—Ü —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  const allBreaks = [0, ...verticalBreaks, viewport.width];
  allBreaks.sort((a, b) => a - b);

  // –£–±–∏—Ä–∞–µ–º –∫—Ä–∞–π–Ω–∏–µ –ø—É—Å—Ç—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (–µ—Å–ª–∏ –Ω–µ—Ç –±–ª–æ–∫–æ–≤)
  const columns = [];
  for (let i = 0; i < allBreaks.length - 1; i++) {
    const left = allBreaks[i];
    const right = allBreaks[i + 1];

    // –§–∏–ª—å—Ç—Ä—É–µ–º –±–ª–æ–∫–∏ –≤ —ç—Ç–æ–π –∫–æ–ª–æ–Ω–∫–µ
    const colBlocks = sorted.filter(b => b.x >= left && b.x < right);
    if (colBlocks.length > 0) { // —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –±–ª–æ–∫–∏
      columns.push(colBlocks);
    }
  }
  return columns;
}
  // if (verticalBreaks.length > 0) {
  //   const columns = [];
  //   let currentColumn = [sorted[0]];

  //   for (let i = 1; i < sorted.length; i++) {
  //     const x = sorted[i].x;
  //     // –ü—Ä–æ–≤–µ—Ä—è–µ–º: –±–ª–∏–∑–∫–æ –ª–∏ –∫ –∫–∞–∫–æ–π-—Ç–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–π –ª–∏–Ω–∏–∏?
  //     const isBreak = verticalBreaks.some(bp => Math.abs(x - bp) < 10); // –¥–æ–ø—É—Å–∫ 10px

  //     if (isBreak) {
  //       columns.push(currentColumn);
  //       currentColumn = [sorted[i]];
  //     } else {
  //       currentColumn.push(sorted[i]);
  //     }
  //   }
  //   columns.push(currentColumn);
  //   return columns;
  // }

  // –ï—Å–ª–∏ –Ω–µ—Ç –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã—Ö –ª–∏–Ω–∏–π ‚Äî –≥—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Ä–∞–∑—Ä—ã–≤–∞–º
  const gaps = [];
  for (let i = 0; i < sorted.length - 1; i++) {
    const gap = sorted[i + 1].x - sorted[i].x;
    gaps.push({ index: i, gap });
  }

  if (gaps.length === 0) {
    return [sorted]; // –æ–¥–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞
  }

  const avgGap = gaps.reduce((sum, g) => sum + g.gap, 0) / gaps.length;
  const COLUMN_THRESHOLD = avgGap * 2;

  const columns = [];
  let currentColumn = [sorted[0]];

  for (let i = 1; i < sorted.length; i++) {
    const gap = sorted[i].x - sorted[i - 1].x;
    if (gap > COLUMN_THRESHOLD) {
      columns.push(currentColumn);
      currentColumn = [sorted[i]];
    } else {
      currentColumn.push(sorted[i]);
    }
  }
  columns.push(currentColumn);
  return columns;
}

    function updateHeaderFloorSelect() {
  const select = document.getElementById('headerFloorSelect');
  select.innerHTML = '<option value="-1">–ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</option>';
  
  structuredRows.forEach((row, i) => {
    const option = document.createElement('option');
    option.value = i;
    // –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π –±–ª–æ–∫ –∫–∞–∫ –ø—Ä–µ–≤—å—é
    const preview = row.blocks.map(b => b.text).join(' | ').substring(0, 50);
    // const preview = row.blocks.length ? row.blocks[0].text.substring(0, 30) : '–ü—É—Å—Ç–æ';
    option.textContent = `–≠—Ç–∞–∂ ${i + 1}: ${preview}`;
    select.appendChild(option);
  });
  
  select.disabled = structuredRows.length === 0;
}

    // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–∏—Ç—å –≤—ã–≤–æ–¥ –∏ –º–µ—Ç–∫–∏ ===
    function updateOutputAndLabels() {
      document.getElementById('output').innerHTML = '';
      document.querySelectorAll('.debug-label:not(.line-label)').forEach(el => el.remove());

      structuredRows.forEach((row, rowIndex) => {
        document.getElementById('output').innerHTML += `--- –°—Ç—Ä–æ–∫–∞ ${rowIndex} (Y=${row.y.toFixed(1)}) ---\n`;
        row.blocks.forEach((block, i) => {
          const screenX = block.x;
          const screenY = block.y;

          document.getElementById('output').innerHTML += 
            `  [${i}] X:${block.x.toFixed(1)} | "${block.text}"\n`;

          const label = document.createElement('div');
          label.className = 'debug-label';
          label.textContent = `"${block.text}"`;
          label.style.left = `${screenX}px`;
          label.style.top = `${screenY}px`;
          document.getElementById('canvasContainer').appendChild(label);
        });
      });
    }

    // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –≠–¢–ê–ñ–ê–ú–ò ===
    function updateFloorPanel() {
      const floorCount = structuredRows.length;
      if (floorCount === 0) {
        document.getElementById('currentFloor').textContent = '-';
        document.getElementById('floorTopLine').textContent = '-';
        document.getElementById('floorBottomLine').textContent = '-';
        document.getElementById('floorContent').textContent = '[–ù–µ—Ç —Å—Ç—Ä–æ–∫]';
        return;
      }

      if (currentFloorIndex < 0) currentFloorIndex = 0;
      if (currentFloorIndex >= floorCount) currentFloorIndex = floorCount - 1;

      const currentFloor = structuredRows[currentFloorIndex];
      document.getElementById('currentFloor').textContent = `${currentFloorIndex + 1} –∏–∑ ${floorCount}`;

      const topLine = currentFloor.topLine ? `Y=${Math.round(currentFloor.topLine.y)}` : '–í–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞';
      const bottomLine = currentFloor.bottomLine ? `Y=${Math.round(currentFloor.bottomLine.y)}` : '–ù–∏–∂–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞';
      document.getElementById('floorTopLine').textContent = topLine;
      document.getElementById('floorBottomLine').textContent = bottomLine;

      const content = currentFloor.blocks.map((b, i) => `  [${i}] "${b.text}"`).join('\n');
      document.getElementById('floorContent').textContent = content;

      // –†–∏—Å—É–µ–º —Å–∏–Ω—é—é —Ä–∞–º–∫—É –≤–æ–∫—Ä—É–≥ —ç—Ç–∞–∂–∞
      drawFloorHighlight(currentFloor);
    }

//     document.getElementById('createHtmlTableBtn').addEventListener('click', () => {
//   if (structuredRows.length === 0) {
//     alert('–°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–∞—Ä—É–∂—å—Ç–µ –ª–∏–Ω–∏–∏!');
//     return;
//   }

//   const htmlTable = generateHtmlTable();
//   document.getElementById('htmlTableCode').textContent = htmlTable;
//   document.getElementById('htmlTableOutput').style.display = 'block';
// });

function generateHtmlTable() {
  if (structuredRows.length < 2) {
    return '<p>–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —Å—Ç—Ä–æ–∫–∏</p>';
  }

  // –ë–µ—Ä—ë–º –í–¢–û–†–û–ô —ç—Ç–∞–∂ (–∏–Ω–¥–µ–∫—Å 1) ‚Äî –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —ç—Ç–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö
//   const referenceRow = structuredRows[1];
let referenceRow = structuredRows[0];
for (let row of structuredRows) {
  if (row.blocks.length > referenceRow.blocks.length) {
    referenceRow = row;
  }
}
  if (!referenceRow || referenceRow.blocks.length === 0) {
    return '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤–æ –≤—Ç–æ—Ä–æ–π —Å—Ç—Ä–æ–∫–µ</p>';
  }

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º –±–ª–æ–∫–∏ –ø–æ X
  const sortedBlocks = [...referenceRow.blocks].sort((a, b) => a.x - b.x);

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã —Å—Ç–æ–ª–±—Ü–æ–≤ –ø–æ —Ä–∞–∑—Ä—ã–≤–∞–º > 80px
  const COLUMN_GAP = 80; // –ø–∏–∫—Å–µ–ª–µ–π
  const columns = [];
  let currentStart = sortedBlocks[0].x;

  for (let i = 0; i < sortedBlocks.length; i++) {
    const current = sortedBlocks[i];
    const next = sortedBlocks[i + 1];

    if (!next || (next.x - current.x) > COLUMN_GAP) {
      // –ö–æ–Ω–µ—Ü —Å—Ç–æ–ª–±—Ü–∞
      columns.push({
        minX: currentStart,
        maxX: current.x + (current.text.length * 6), // –ø—Ä–∏–±–ª–∏–∑–∏—Ç–µ–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —Ç–µ–∫—Å—Ç–∞
        center: (currentStart + current.x) / 2
      });
      if (next) currentStart = next.x;
    }
  }

  if (columns.length === 0) {
    return '<p>–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å—Ç–æ–ª–±—Ü—ã</p>';
  }

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
//   let html = '<table border="1" cellpadding="12" cellspacing="0" style="border-collapse: collapse; font-family: Arial, sans-serif; width: 80%; margin: 40px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-radius: 15px; overflow: hidden;">\n';
//   let html = '<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; font-family: Arial, sans-serif; margin: 20px 0;">\n';
    let html = '<table class="pdf-table">\n';

  structuredRows.forEach(row => {
    html += '  <tr>\n';
    
    // –°–æ–∑–¥–∞—ë–º —è—á–µ–π–∫–∏ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å—Ç–æ–ª–±—Ü–æ–≤
    const cells = Array(columns.length).fill('');

    // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –±–ª–æ–∫–∏ –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º
    row.blocks.forEach(block => {
      // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–π —Å—Ç–æ–ª–±–µ—Ü –ø–æ X
      let bestColIndex = 0;
      let minDist = Math.abs(block.x - columns[0].center);
      
      for (let i = 1; i < columns.length; i++) {
        const dist = Math.abs(block.x - columns[i].center);
        if (dist < minDist) {
          minDist = dist;
          bestColIndex = i;
        }
      }
      
      cells[bestColIndex] = cells[bestColIndex] ? 
        `${cells[bestColIndex]}<br>${block.text}` : 
        block.text;
    });

    cells.forEach(cell => {
  html += `    <td>${cell || ''}</td>\n`;
});

    // cells.forEach(cell => {
    //   html += `    <td>${cell || ''}</td>\n`;
    // });

    html += '  </tr>\n';
  });

  html += '</table>';
  return html;
}


// function generateHtmlTable() {
//   if (structuredRows.length === 0) return '<p>–ù–µ—Ç —Å—Ç—Ä–æ–∫</p>';

//   // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ X-–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
//   const allXs = structuredRows
//     .flatMap(row => row.blocks)
//     .map(block => block.x)
//     .sort((a, b) => a - b);

//   if (allXs.length === 0) return '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>';

//   // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º X –≤ —Å—Ç–æ–ª–±—Ü—ã —Å –¥–æ–ø—É—Å–∫–æ–º
//   const COLUMN_TOLERANCE = 20; // –ø–∏–∫—Å–µ–ª–µ–π
//   const columns = [];
//   let currentColumn = { minX: allXs[0], maxX: allXs[0], blocks: [] };

//   for (let x of allXs) {
//     if (x - currentColumn.maxX <= COLUMN_TOLERANCE) {
//       // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Ç–µ–∫—É—â–∏–π —Å—Ç–æ–ª–±–µ—Ü
//       currentColumn.maxX = x;
//     } else {
//       // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–æ–ª–±–µ—Ü –∏ –Ω–∞—á–∏–Ω–∞–µ–º –Ω–æ–≤—ã–π
//       columns.push({ ...currentColumn });
//       currentColumn = { minX: x, maxX: x, blocks: [] };
//     }
//   }
//   columns.push(currentColumn); // –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–æ–ª–±–µ—Ü

//   // –¢–µ–ø–µ—Ä—å –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –±–ª–æ–∫–∏ –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º
//   let html = '<table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; font-family: Arial, sans-serif; margin: 20px 0;">\n';

//   structuredRows.forEach(row => {
//     html += '  <tr>\n';
    
//     // –°–æ–∑–¥–∞—ë–º –º–∞—Å—Å–∏–≤ —è—á–µ–µ–∫ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å—Ç–æ–ª–±—Ü–æ–≤
//     const cells = Array(columns.length).fill('');

//     // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –±–ª–æ–∫–∏ –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º
//     row.blocks.forEach(block => {
//       // –ù–∞—Ö–æ–¥–∏–º —Å—Ç–æ–ª–±–µ—Ü, –≤ –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ø–∞–¥–∞–µ—Ç –±–ª–æ–∫
//       const colIndex = columns.findIndex(col => 
//         block.x >= col.minX - COLUMN_TOLERANCE/2 && 
//         block.x <= col.maxX + COLUMN_TOLERANCE/2
//       );
      
//       if (colIndex !== -1) {
//         cells[colIndex] = cells[colIndex] ? 
//           `${cells[colIndex]}<br>${block.text}` : 
//           block.text;
//       }
//     });

//     // –í—ã–≤–æ–¥–∏–º —è—á–µ–π–∫–∏
//     cells.forEach(cell => {
//       html += `    <td>${cell || ''}</td>\n`;
//     });

//     html += '  </tr>\n';
//   });

//   html += '</table>';
//   return html;
// } 

function drawFloorHighlight(floor) {
  // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ä–∞–º–∫—É
  const oldBox = document.querySelector('.highlight-box');
  if (oldBox) oldBox.remove();

  if (!floor) return;

  // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ª–∏–Ω–∏–π —ç—Ç–∞–∂–∞
  const topLineY = floor.topLine ? floor.topLine.y : 0;
  const bottomLineY = floor.bottomLine ? floor.bottomLine.y : canvas.height;

  // –®–∏—Ä–∏–Ω–∞ ‚Äî –≤—Å—è —à–∏—Ä–∏–Ω–∞ canvas
  const leftX = 0;
  const rightX = canvas.width;

  const box = document.createElement('div');
  box.className = 'highlight-box';
  box.style.left = `${leftX}px`;
  box.style.top = `${topLineY}px`;
  box.style.width = `${rightX - leftX}px`;
  box.style.height = `${bottomLineY - topLineY}px`;
  document.getElementById('canvasContainer').appendChild(box);
}
    // function drawFloorHighlight(floor) {
    //   // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ä–∞–º–∫—É
    //   const oldBox = document.querySelector('.highlight-box');
    //   if (oldBox) oldBox.remove();

    //   if (!floor || !floor.blocks || floor.blocks.length === 0) return;

    //   // –ù–∞—Ö–æ–¥–∏–º –≥—Ä–∞–Ω–∏—Ü—ã —ç—Ç–∞–∂–∞
    //   const minY = Math.min(...floor.blocks.map(b => b.y));
    //   const maxY = Math.max(...floor.blocks.map(b => b.y));
    //   const minX = Math.min(...floor.blocks.map(b => b.x));
    //   const maxX = Math.max(...floor.blocks.map(b => b.x));

    //   const box = document.createElement('div');
    //   box.className = 'highlight-box';
    //   box.style.left = `${minX}px`;
    //   box.style.top = `${minY}px`;
    //   box.style.width = `${maxX - minX}px`;
    //   box.style.height = `${maxY - minY}px`;
    //   document.getElementById('canvasContainer').appendChild(box);
    // }

    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —ç—Ç–∞–∂–∞–º
    document.getElementById('prevFloor').addEventListener('click', () => {
      if (structuredRows.length > 0) {
        currentFloorIndex--;
        if (currentFloorIndex < 0) currentFloorIndex = structuredRows.length - 1;
        updateFloorPanel();
      }
    });

    document.getElementById('nextFloor').addEventListener('click', () => {
      if (structuredRows.length > 0) {
        currentFloorIndex++;
        if (currentFloorIndex >= structuredRows.length) currentFloorIndex = 0;
        updateFloorPanel();
      }
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', () => {
      updateFloorPanel();
    });

    // –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å HTML –≤ –±—É—Ñ–µ—Ä
document.getElementById('copyHtmlBtn').addEventListener('click', async () => {
  const html = generateHtmlTable();
  try {
    await navigator.clipboard.writeText(html);
    document.getElementById('status').textContent = 'HTML —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä!';
  } catch (err) {
    document.getElementById('status').textContent = '–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è: ' + err.message;
  }
});

// –ü–æ–∫–∞–∑–∞—Ç—å HTML –∫–∞–∫ —Ä–µ–Ω–¥–µ—Ä
document.getElementById('showHtmlBtn').addEventListener('click', () => {
  const html = generateHtmlTable();
  document.getElementById('renderedHtmlTable').innerHTML = html;
  document.getElementById('htmlOverlay').style.display = 'block';
});

// –ó–∞–∫—Ä—ã—Ç—å –æ–≤–µ—Ä–ª–µ–π
document.getElementById('closeHtmlOverlay').addEventListener('click', () => {
  document.getElementById('htmlOverlay').style.display = 'none';
});
  
let isSelecting = false;
let startX = 0;
let startY = 0;
const selectionRect = document.getElementById('selectionRect');
const canvasContainer = document.getElementById('canvasContainer');

document.getElementById('enableSelectMode').addEventListener('click', () => {
  isSelecting = true;
  document.getElementById('status').textContent = '–í—ã–¥–µ–ª–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å –Ω–∞ PDF...';
});

canvasContainer.addEventListener('mousedown', (e) => {
  if (!isSelecting || !currentTextContent) return;
  
  const rect = canvasContainer.getBoundingClientRect();
  startX = e.clientX - rect.left;
  startY = e.clientY - rect.top;

  // –ü–æ–ª—É—á–∞–µ–º selectionRect –¢–û–õ–¨–ö–û –ö–û–ì–î–ê –ù–£–ñ–ï–ù ‚Äî –∏ —Ç–æ—á–Ω–æ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ DOM
  const selectionRect = document.getElementById('selectionRect');
  selectionRect.style.display = 'block';
  selectionRect.style.left = startX + 'px';
  selectionRect.style.top = startY + 'px';
  selectionRect.style.width = '0px';
  selectionRect.style.height = '0px';
});

canvasContainer.addEventListener('mousemove', (e) => {
  if (!isSelecting) return;
  
  const rect = canvasContainer.getBoundingClientRect();
  const currentX = e.clientX - rect.left;
  const currentY = e.clientY - rect.top;
  
  const width = currentX - startX;
  const height = currentY - startY;

  const selectionRect = document.getElementById('selectionRect');
  selectionRect.style.left = Math.min(startX, currentX) + 'px';
  selectionRect.style.top = Math.min(startY, currentY) + 'px';
  selectionRect.style.width = Math.abs(width) + 'px';
  selectionRect.style.height = Math.abs(height) + 'px';
});

canvasContainer.addEventListener('mouseup', async (e) => {
  if (!isSelecting) return;
  
  isSelecting = false;
  const selectionRect = document.getElementById('selectionRect');
  selectionRect.style.display = 'none';

  const rect = canvasContainer.getBoundingClientRect();
  const endX = e.clientX - rect.left;
  const endY = e.clientY - rect.top;

  const selLeft = Math.min(startX, endX);
  const selTop = Math.min(startY, endY);
  const selRight = Math.max(startX, endX);
  const selBottom = Math.max(startY, endY);

  let html = '';
  currentTextContent.items.forEach(item => {
    if (!item.str.trim()) return;
    const [,, , , x, y] = item.transform;
    const pt = viewport.convertToViewportPoint(x, y);
    const tx = pt[0];
    const ty = pt[1];
    
    if (tx >= selLeft && tx <= selRight && ty >= selTop && ty <= selBottom) {
      // –¢–µ–ø–µ—Ä—å —Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏!
      html += `<div style="position:absolute; left:${tx}px; top:${ty}px; white-space:nowrap;">${item.str.trim()}</div>`;
    }
  });

  if (html) {
    // –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî —á—Ç–æ–±—ã –ø—Ä–∏ –≤—Å—Ç–∞–≤–∫–µ –≤—Å—ë –±—ã–ª–æ –Ω–∞ —Å–≤–æ–∏—Ö –º–µ—Å—Ç–∞—Ö
    const fullHtml = `<div style="position:relative; width:${viewport.width}px; height:${viewport.height}px; background:white;">${html}</div>`;
    try {
      await navigator.clipboard.writeText(fullHtml);
      document.getElementById('status').textContent = '‚úÖ –ü—Ä–æ—Å—Ç–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
    } catch (err) {
      console.error(err);
      document.getElementById('status').textContent = '‚ùå –û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è';
    }
  } else {
    document.getElementById('status').textContent = '‚ö†Ô∏è –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–¥–µ–ª–µ–Ω–æ';
  }
});
// =============== –ù–û–í–´–ô –†–ï–ñ–ò–ú: –†–ï–ì–ò–û–ù–´ (–¢–û–õ–¨–ö–û –í –ë–£–§–ï–†, –ë–ï–ó –û–ö–ù–ê) ===============

let isNewRegionMode = false;
let newRegions = [];
let newStart = null;
let newTempRect = null;

// –ö–Ω–æ–ø–∫–∏
const regionModeBtn = document.getElementById('regionModeBtn');
const exportRegionsBtn = document.getElementById('exportRegionsBtn');
// const canvasContainer = document.getElementById('canvasContainer'); // ‚Üê –æ—Å—Ç–∞–≤–∏—Ç—å –û–î–ù–£

regionModeBtn.addEventListener('click', () => {
  isNewRegionMode = !isNewRegionMode;
  regionModeBtn.textContent = isNewRegionMode 
    ? '‚ùå –í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ —Ä–µ–≥–∏–æ–Ω–æ–≤' 
    : 'ü°í –†–µ–∂–∏–º —Ä–µ–≥–∏–æ–Ω–æ–≤ (–Ω–æ–≤—ã–π)';
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º—ã—à–∏ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω —Ä–µ–∂–∏–º
canvasContainer.addEventListener('mousedown', (e) => {
  if (!isNewRegionMode || !currentTextContent) return;
  e.preventDefault();
  const rect = canvasContainer.getBoundingClientRect();
  newStart = { x: e.clientX - rect.left, y: e.clientY - rect.top };

  newTempRect = document.createElement('div');
  newTempRect.style.cssText = `
    position: absolute;
    border: 2px dashed #8e44ad;
    background: rgba(142, 68, 173, 0.1);
    pointer-events: none;
    z-index: 9999;
  `;
  canvasContainer.appendChild(newTempRect);
});

canvasContainer.addEventListener('mousemove', (e) => {
  if (!isNewRegionMode || !newStart || !newTempRect) return;
  e.preventDefault();
  const rect = canvasContainer.getBoundingClientRect();
  const curX = e.clientX - rect.left;
  const curY = e.clientY - rect.top;

  const x = Math.min(newStart.x, curX);
  const y = Math.min(newStart.y, curY);
  const w = Math.abs(curX - newStart.x);
  const h = Math.abs(curY - newStart.y);

  newTempRect.style.left = x + 'px';
  newTempRect.style.top = y + 'px';
  newTempRect.style.width = w + 'px';
  newTempRect.style.height = h + 'px';
});

canvasContainer.addEventListener('mouseup', (e) => {
  if (!isNewRegionMode || !newTempRect) return;
  e.preventDefault();

  canvasContainer.removeChild(newTempRect);
  newTempRect = null;

  const rect = canvasContainer.getBoundingClientRect();
  const endX = e.clientX - rect.left;
  const endY = e.clientY - rect.top;

  const x = Math.min(newStart.x, endX);
  const y = Math.min(newStart.y, endY);
  const w = Math.abs(endX - newStart.x);
  const h = Math.abs(endY - newStart.y);

  newStart = null;

  if (w < 10 || h < 10) return;

  // –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
  let baseName = "–†–µ–≥–∏–æ–Ω";
  let name = `${baseName} ${newRegions.length + 1}`;
  let idx = 1;
  while (newRegions.some(r => r.name === name)) {
    name = `${baseName} ${newRegions.length + 1}_${idx++}`;
  }

  const regionId = 'new-region-' + Date.now();
  const regionEl = document.createElement('div');
  regionEl.id = regionId;
  regionEl.style.cssText = `
    position: absolute;
    border: 2px solid #8e44ad;
    background: rgba(142, 68, 173, 0.05);
    z-index: 9998;
    cursor: pointer;
  `;
  regionEl.style.left = x + 'px';
  regionEl.style.top = y + 'px';
  regionEl.style.width = w + 'px';
  regionEl.style.height = h + 'px';

  regionEl.addEventListener('dblclick', () => {
    const newName = prompt('–ò–º—è —Ä–µ–≥–∏–æ–Ω–∞:', name);
    if (newName?.trim()) {
      const clean = newName.trim();
      if (newRegions.some(r => r.id !== regionId && r.name === clean)) {
        alert('–ò–º—è —É–∂–µ –∑–∞–Ω—è—Ç–æ!');
        return;
      }
      name = clean;
      const r = newRegions.find(r => r.id === regionId);
      if (r) r.name = name;
    }
  });

  canvasContainer.appendChild(regionEl);
  newRegions.push({ id: regionId, x, y, width: w, height: h, name, el: regionEl });
});

// üî• –≠–ö–°–ü–û–†–¢ –í –ë–£–§–ï–† –û–ë–ú–ï–ù–ê (–ù–ï –í –û–ö–ù–û!)
exportRegionsBtn.addEventListener('click', async () => {
  if (newRegions.length === 0) return alert('–ù–µ—Ç —Ä–µ–≥–∏–æ–Ω–æ–≤!');
  if (!currentTextContent || !viewport) return alert('PDF –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!');

  // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ä–µ–≥–∏–æ–Ω—ã –ø–æ Y (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑), —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫
  const sortedRegions = [...newRegions].sort((a, b) => a.y - b.y);

  let fullHtml = `<div style="position: relative; width: ${viewport.width}px; height: ${viewport.height}px; background: white; font-family: Arial, sans-serif;">\n`;

  sortedRegions.forEach((region, index) => {
    const items = [];

    // –°–æ–±–∏—Ä–∞–µ–º —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –±–ª–æ–∫–∏ –≤ —Ä–µ–≥–∏–æ–Ω–µ
    currentTextContent.items
      .filter(item => item.str.trim())
      .forEach(item => {
        const [,, , , x, y] = item.transform;
        const pt = viewport.convertToViewportPoint(x, y);
        const globalX = pt[0];
        const globalY = pt[1];

        if (
          globalX >= region.x && globalX <= region.x + region.width &&
          globalY >= region.y && globalY <= region.y + region.height
        ) {
          items.push({ text: item.str.trim(), x: globalX, y: globalY });
        }
      });

    if (items.length === 0) return;

    // === –ì–†–£–ü–ü–ò–†–£–ï–ú –ü–û –°–¢–†–û–ö–ê–ú (Y —Å –¥–æ–ø—É—Å–∫–æ–º 5px) ===
    const TOLERANCE = 5;
    const lines = [];
    const sortedByY = items.sort((a, b) => a.y - b.y);

    for (const item of sortedByY) {
      let line = lines.find(l => Math.abs(l.y - item.y) <= TOLERANCE);
      if (!line) {
        line = { y: item.y, words: [] };
        lines.push(line);
      }
      line.words.push({ text: item.text, x: item.x });
    }

    // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Å–ª–æ–≤–∞ –≤ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–µ –ø–æ X
    lines.forEach(line => {
      line.words.sort((a, b) => a.x - b.x);
    });

    // –°–æ–±–∏—Ä–∞–µ–º HTML –¥–ª—è —Å—Ç—Ä–æ–∫–∏
    let blockHtml = '';
    lines.forEach(line => {
      const lineText = line.words.map(w => w.text).join(' ');
      blockHtml += `<div>${lineText}</div>\n`;
    });

    // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
    const blockId = `block_${index + 1}`;

    // –†–∞–º–∫–∞ ‚Äî –∞–±—Å–æ–ª—é—Ç–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è, —Ä–∞–∑–º–µ—Ä ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π
    fullHtml += `<div id="${blockId}" style="
      position: absolute;
      left: ${region.x}px;
      top: ${region.y}px;
      border: 2px solid #e74c3c;
      padding: 8px;
      background: #fff9f9;
      border-radius: 4px;
      font-size: 14px;
      line-height: 1.4;
      box-sizing: border-box;
      min-width: 100px;
      max-width: 600px;
    ">${blockHtml}</div>\n`;
  });

  fullHtml += `</div>`;

  try {
    await navigator.clipboard.writeText(fullHtml);
    document.getElementById('status').textContent = `‚úÖ –†–µ–≥–∏–æ–Ω—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã ‚Äî —Ç–æ—á–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ + —É–º–Ω—ã–π —Ç–µ–∫—Å—Ç!`;
  } catch (err) {
    console.error(err);
    alert('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è');
  }
});
  
// === –ü–û–õ–ù–´–ô –ö–õ–û–ù PDF ‚Üí –¢–û–ß–ù–û –ö–ê–ö –í –†–ï–ñ–ò–ú–ï –í–´–î–ï–õ–ï–ù–ò–Ø, –ù–û –ë–ï–ó –†–ê–ú–ö–ò ===
document.getElementById('exportFullHtmlBtn').addEventListener('click', async () => {
  if (!currentTextContent || !viewport) {
    alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ PDF!');
    return;
  }

  let html = `<div style="position: relative; width: ${viewport.width}px; height: ${viewport.height}px; background: white;">\n`;

  currentTextContent.items.forEach(item => {
    if (!item.str.trim()) return;
    const [,, , , x, y] = item.transform;
    const pt = viewport.convertToViewportPoint(x, y);
    const tx = pt[0];
    const ty = pt[1];
    
    // –≠–∫—Ä–∞–Ω–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    const safeText = item.str.trim()
      .replace(/&/g, '&amp;')
      .replace(/</g, '<')
      .replace(/>/g, '>');
    
    html += `<div style="position: absolute; left: ${tx}px; top: ${ty}px; white-space: nowrap;">${safeText}</div>\n`;
  });

  html += `</div>`;

  try {
    await navigator.clipboard.writeText(html);
    document.getElementById('status').textContent = '‚úÖ –ü–æ–ª–Ω—ã–π –∫–ª–æ–Ω PDF —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä!';
  } catch (err) {
    console.error(err);
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞: —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª, –µ—Å–ª–∏ –±—É—Ñ–µ—Ä –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
    const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pdf-full-clone.html';
    a.click();
    URL.revokeObjectURL(url);
    document.getElementById('status').textContent = '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∫–∞–∫ —Ñ–∞–π–ª (–±—É—Ñ–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω)';
  }
});
  
  
  </script>
  
</body>
</html>
